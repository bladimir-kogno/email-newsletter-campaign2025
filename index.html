<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lumail Campaign Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Mobile optimizations */
        @media (max-width: 640px) {
            .nav-btn { padding: 8px 12px; font-size: 14px; }
            .mobile-scroll { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .mobile-card { margin: 0 -1rem; border-radius: 0; }
        }
        
        body { overflow-x: hidden; }
        button, .btn { min-height: 44px; min-width: 44px; }
        .transition-all { transition: all 0.2s ease-in-out; }
        
        .step-indicator { display: flex; align-items: center; margin-bottom: 2rem; }
        .step { display: flex; align-items: center; font-size: 0.875rem; }
        .step-number { 
            width: 24px; height: 24px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            margin-right: 0.5rem; font-weight: bold; 
        }
        .step.active .step-number { background-color: #3b82f6; color: white; }
        .step.completed .step-number { background-color: #10b981; color: white; }
        .step.inactive .step-number { background-color: #e5e7eb; color: #6b7280; }
        .step-separator { width: 2rem; height: 1px; background-color: #e5e7eb; margin: 0 1rem; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <div class="min-h-screen flex items-center justify-center">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Loading LUMail Campaign Manager...</p>
            </div>
        </div>
    </div>

    <script>
        console.log('Starting app initialization...');
        
        // Email Campaign Manager App
        class EmailCampaignApp {
            constructor() {
                this.user = null;
                this.subscribers = [];
                this.campaigns = [];
                this.currentView = 'dashboard';
                this.editingCampaign = null;
                this.campaignStep = 1;
                this.newCampaign = {
                    title: '',
                    subject: '',
                    content: '',
                    selectedSubscribers: []
                };
                this.fromEmail = 'newsletter@lumail.co.uk';
                
                // Initialize immediately
                this.init();
            }

            init() {
                try {
                    console.log('App init started');
                    this.loadUserData();
                    
                    const savedUser = localStorage.getItem('current_user');
                    if (savedUser) {
                        try {
                            this.user = JSON.parse(savedUser);
                            console.log('User loaded from storage:', this.user.email);
                        } catch (e) {
                            console.error('Error parsing saved user:', e);
                            localStorage.removeItem('current_user');
                        }
                    }
                    
                    this.render();
                    this.initializeIcons();
                    console.log('App initialization complete');
                } catch (error) {
                    console.error('Init error:', error);
                    document.getElementById('app').innerHTML = '<div class="p-8 text-center text-red-600">Error loading app. Please refresh the page.</div>';
                }
            }

            // Authentication methods
            showSignIn() {
                const signinForm = document.getElementById('signin-form');
                const signupForm = document.getElementById('signup-form');
                if (signinForm && signupForm) {
                    signinForm.classList.remove('hidden');
                    signupForm.classList.add('hidden');
                }
            }

            showSignUp() {
                const signinForm = document.getElementById('signin-form');
                const signupForm = document.getElementById('signup-form');
                if (signinForm && signupForm) {
                    signinForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
                }
            }

            handleSignIn() {
                try {
                    const email = document.getElementById('signin-email')?.value.trim();
                    const password = document.getElementById('signin-password')?.value;

                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }

                    const users = JSON.parse(localStorage.getItem('app_users') || '{}');
                    const user = users[email];
                    
                    if (user && user.password === password) {
                        this.user = {
                            id: user.id,
                            email: user.email,
                            firstName: user.firstName,
                            emailAddresses: [{ emailAddress: user.email }]
                        };
                        localStorage.setItem('current_user', JSON.stringify(this.user));
                        this.loadUserData();
                        this.render();
                    } else {
                        alert('Invalid email or password');
                    }
                } catch (error) {
                    console.error('Sign in error:', error);
                    alert('Error signing in. Please try again.');
                }
            }

            handleSignUp() {
                try {
                    const email = document.getElementById('signup-email')?.value.trim();
                    const password = document.getElementById('signup-password')?.value;
                    const firstName = document.getElementById('signup-name')?.value.trim();

                    if (!email || !password) {
                        alert('Please enter both email and password');
                        return;
                    }

                    if (password.length < 6) {
                        alert('Password must be at least 6 characters');
                        return;
                    }

                    const users = JSON.parse(localStorage.getItem('app_users') || '{}');
                    
                    if (users[email]) {
                        alert('User already exists. Please sign in instead.');
                        this.showSignIn();
                        return;
                    }

                    const user = {
                        id: Date.now().toString(),
                        email,
                        firstName: firstName || 'User',
                        password,
                        createdAt: new Date().toISOString()
                    };

                    users[email] = user;
                    localStorage.setItem('app_users', JSON.stringify(users));

                    this.user = {
                        id: user.id,
                        email: user.email,
                        firstName: user.firstName,
                        emailAddresses: [{ emailAddress: user.email }]
                    };
                    localStorage.setItem('current_user', JSON.stringify(this.user));
                    
                    this.loadUserData();
                    this.render();
                    alert('Account created successfully!');
                } catch (error) {
                    console.error('Sign up error:', error);
                    alert('Error creating account. Please try again.');
                }
            }

            enterDemoMode() {
                try {
                    this.user = {
                        id: 'demo',
                        email: 'demo@example.com',
                        firstName: 'Demo User',
                        emailAddresses: [{ emailAddress: 'demo@example.com' }]
                    };
                    localStorage.setItem('current_user', JSON.stringify(this.user));
                    this.loadUserData();
                    this.render();
                } catch (error) {
                    console.error('Demo mode error:', error);
                }
            }

            signOut() {
                this.user = null;
                this.subscribers = [];
                this.campaigns = [];
                localStorage.removeItem('current_user');
                this.render();
            }

            // Data persistence
            loadUserData() {
                try {
                    this.subscribers = JSON.parse(localStorage.getItem('subscribers') || '[]');
                    this.campaigns = JSON.parse(localStorage.getItem('campaigns') || '[]');
                    this.fromEmail = localStorage.getItem('fromEmail') || 'newsletter@lumail.co.uk';
                } catch (error) {
                    console.error('Error loading user data:', error);
                    this.subscribers = [];
                    this.campaigns = [];
                }
            }

            saveData() {
                try {
                    localStorage.setItem('subscribers', JSON.stringify(this.subscribers));
                    localStorage.setItem('campaigns', JSON.stringify(this.campaigns));
                    localStorage.setItem('fromEmail', this.fromEmail);
                } catch (error) {
                    console.error('Error saving data:', error);
                }
            }

            updateSettings(newFromEmail) {
                if (!newFromEmail.includes('@lumail.co.uk')) {
                    alert('From email must use @lumail.co.uk domain');
                    return;
                }
                this.fromEmail = newFromEmail;
                this.saveData();
                alert('Settings updated successfully!');
                this.render();
            }

            // Navigation
            showView(view) {
                this.currentView = view;
                if (view === 'create-campaign') {
                    this.campaignStep = 1;
                    this.newCampaign = {
                        title: '',
                        subject: '',
                        content: '',
                        selectedSubscribers: []
                    };
                }
                this.render();
                window.scrollTo(0, 0);
            }

            // Campaign creation flow
            nextCampaignStep() {
                try {
                    if (this.campaignStep === 1) {
                        const title = document.getElementById('campaignTitle')?.value.trim();
                        const subject = document.getElementById('emailSubject')?.value.trim();
                        const content = document.getElementById('emailContent')?.value.trim();
                        
                        if (!title || !subject || !content) {
                            alert('Please fill in all fields');
                            return;
                        }
                        
                        this.newCampaign.title = title;
                        this.newCampaign.subject = subject;
                        this.newCampaign.content = content;
                        this.campaignStep = 2;
                    } else if (this.campaignStep === 2) {
                        if (this.newCampaign.selectedSubscribers.length === 0) {
                            alert('Please select at least one subscriber');
                            return;
                        }
                        this.campaignStep = 3;
                    }
                    this.render();
                } catch (error) {
                    console.error('Next step error:', error);
                }
            }

            prevCampaignStep() {
                if (this.campaignStep > 1) {
                    this.campaignStep--;
                    this.render();
                }
            }

            toggleSubscriber(subscriberId) {
                const index = this.newCampaign.selectedSubscribers.indexOf(subscriberId);
                if (index > -1) {
                    this.newCampaign.selectedSubscribers.splice(index, 1);
                } else {
                    this.newCampaign.selectedSubscribers.push(subscriberId);
                }
                this.render();
            }

            selectAllSubscribers() {
                this.newCampaign.selectedSubscribers = this.subscribers.map(s => s.id);
                this.render();
            }

            deselectAllSubscribers() {
                this.newCampaign.selectedSubscribers = [];
                this.render();
            }

            async sendTestEmail() {
                try {
                    const testEmail = prompt('Enter your email address to receive a test:');
                    if (!testEmail || !testEmail.includes('@')) {
                        alert('Please enter a valid email address');
                        return;
                    }

                    const response = await fetch('/api/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipients: [{ email: testEmail, name: 'Test User' }],
                            subject: this.newCampaign.subject,
                            content: this.newCampaign.content,
                            fromEmail: this.fromEmail,
                            campaignId: 'test',
                            isTest: true
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert(`Test email sent successfully to ${testEmail}!`);
                    } else {
                        throw new Error(result.error || 'Failed to send test email');
                    }
                } catch (error) {
                    console.error('Test email error:', error);
                    alert(`Failed to send test email: ${error.message}`);
                }
            }

            async createAndSendCampaign() {
                try {
                    const campaign = {
                        id: Date.now(),
                        title: this.newCampaign.title,
                        subject: this.newCampaign.subject,
                        content: this.newCampaign.content,
                        dateCreated: new Date().toISOString(),
                        status: 'sending',
                        sentCount: 0,
                        targetCount: this.newCampaign.selectedSubscribers.length
                    };
                    
                    this.campaigns.push(campaign);
                    this.saveData();

                    const selectedSubs = this.subscribers.filter(s => 
                        this.newCampaign.selectedSubscribers.includes(s.id)
                    );

                    const response = await fetch('/api/send-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            recipients: selectedSubs,
                            subject: campaign.subject,
                            content: campaign.content,
                            fromEmail: this.fromEmail,
                            campaignId: campaign.id
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        this.updateCampaign(campaign.id, {
                            status: 'sent',
                            sentCount: result.sent,
                            dateSent: new Date().toISOString(),
                            failedCount: result.failed || 0
                        });
                        
                        alert(`Campaign sent successfully to ${result.sent} subscribers!`);
                        this.showView('campaigns');
                    } else {
                        throw new Error(result.error || 'Failed to send campaign');
                    }
                } catch (error) {
                    console.error('Send campaign error:', error);
                    alert(`Failed to send campaign: ${error.message}`);
                }
            }

            // Subscriber management
            addSubscriber(email, name = '') {
                if (this.subscribers.find(s => s.email === email)) {
                    alert('Subscriber already exists!');
                    return false;
                }
                
                const subscriber = {
                    id: Date.now(),
                    email,
                    name,
                    dateAdded: new Date().toISOString(),
                    status: 'active'
                };
                
                this.subscribers.push(subscriber);
                this.saveData();
                return true;
            }

            removeSubscriber(id) {
                if (confirm('Are you sure you want to remove this subscriber?')) {
                    this.subscribers = this.subscribers.filter(s => s.id !== id);
                    this.saveData();
                    this.render();
                }
            }

            updateCampaign(id, updates) {
                const index = this.campaigns.findIndex(c => c.id === id);
                if (index !== -1) {
                    this.campaigns[index] = { ...this.campaigns[index], ...updates };
                    this.saveData();
                }
            }

            deleteCampaign(id) {
                if (confirm('Are you sure you want to delete this campaign?')) {
                    this.campaigns = this.campaigns.filter(c => c.id !== id);
                    this.saveData();
                    this.render();
                }
            }

            // Render methods
            render() {
                try {
                    const app = document.getElementById('app');
                    
                    if (!this.user) {
                        const savedUser = localStorage.getItem('current_user');
                        if (savedUser) {
                            try {
                                this.user = JSON.parse(savedUser);
                                this.loadUserData();
                            } catch (e) {
                                localStorage.removeItem('current_user');
                            }
                        }
                    }
                    
                    if (!this.user) {
                        app.innerHTML = this.getLoginPage();
                    } else {
                        app.innerHTML = this.getLayout();
                    }
                    
                    this.initializeIcons();
                } catch (error) {
                    console.error('Render error:', error);
                }
            }

            getLoginPage() {
                return `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center py-4 px-4 sm:px-6 lg:px-8">
                        <div class="max-w-md w-full space-y-6">
                            <div class="text-center">
                                <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-900">
                                    Lumail Campaign Manager
                                </h2>
                                <p class="mt-2 text-sm text-gray-600">
                                    Professional email campaigns from @lumail.co.uk
                                </p>
                            </div>
                            
                            <div class="bg-white py-6 px-4 shadow-lg sm:rounded-lg sm:px-8">
                                <!-- Sign In Form -->
                                <div id="signin-form" class="space-y-6">
                                    <div>
                                        <label for="signin-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input id="signin-email" type="email" required 
                                               class="w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                               placeholder="Enter your email">
                                    </div>
                                    
                                    <div>
                                        <label for="signin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                        <input id="signin-password" type="password" required 
                                               class="w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                               placeholder="Enter your password">
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <button onclick="window.app.handleSignIn()" 
                                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-all">
                                            Sign In
                                        </button>
                                        
                                        <div class="text-center">
                                            <button type="button" onclick="window.app.showSignUp()" 
                                                    class="text-sm text-indigo-600 hover:text-indigo-500 underline">
                                                Don't have an account? Sign up
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Sign Up Form -->
                                <div id="signup-form" class="space-y-6 hidden">
                                    <div>
                                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                        <input id="signup-email" type="email" required 
                                               class="w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                               placeholder="Enter your email">
                                    </div>
                                    
                                    <div>
                                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                                        <input id="signup-password" type="password" required 
                                               class="w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                               placeholder="At least 6 characters">
                                    </div>
                                    
                                    <div>
                                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">First Name</label>
                                        <input id="signup-name" type="text" 
                                               class="w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-base"
                                               placeholder="Your first name">
                                    </div>
                                    
                                    <div class="space-y-4">
                                        <button onclick="window.app.handleSignUp()" 
                                                class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 transition-all">
                                            Create Account
                                        </button>
                                        
                                        <div class="text-center">
                                            <button type="button" onclick="window.app.showSignIn()" 
                                                    class="text-sm text-indigo-600 hover:text-indigo-500 underline">
                                                Already have an account? Sign in
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                

                            </div>
                        </div>
                    </div>
                `;
            }

            getLayout() {
                return `
                    <div class="min-h-screen bg-gray-50">
                        ${this.getHeader()}
                        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8 py-4 sm:py-8">
                            ${this.getMainContent()}
                        </div>
                    </div>
                `;
            }

            getHeader() {
                return `
                    <header class="bg-white shadow-sm">
                        <div class="max-w-7xl mx-auto px-2 sm:px-4 lg:px-8">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4 sm:py-6 space-y-4 sm:space-y-0">
                                <div>
                                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-900">
                                        Lumail Campaign Manager
                                    </h1>
                                    <span class="text-xs sm:text-sm text-gray-500">
                                        Welcome, ${this.user?.firstName || this.user?.emailAddresses[0]?.emailAddress}
                                    </span>
                                </div>
                                
                                <div class="flex flex-col sm:flex-row items-stretch sm:items-center space-y-3 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                                    <nav class="flex flex-wrap gap-2 sm:gap-4">
                                        <button onclick="window.app.showView('dashboard')" 
                                                class="nav-btn px-3 py-2 text-sm font-medium rounded-md transition-all ${this.currentView === 'dashboard' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}">
                                            Dashboard
                                        </button>
                                        <button onclick="window.app.showView('subscribers')" 
                                                class="nav-btn px-3 py-2 text-sm font-medium rounded-md transition-all ${this.currentView === 'subscribers' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}">
                                            Subscribers
                                        </button>
                                        <button onclick="window.app.showView('campaigns')" 
                                                class="nav-btn px-3 py-2 text-sm font-medium rounded-md transition-all ${this.currentView === 'campaigns' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}">
                                            Campaigns
                                        </button>
                                        <button onclick="window.app.showView('settings')" 
                                                class="nav-btn px-3 py-2 text-sm font-medium rounded-md transition-all ${this.currentView === 'settings' ? 'bg-blue-100 text-blue-700' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-100'}">
                                            Settings
                                        </button>
                                    </nav>
                                    
                                    <button onclick="window.app.signOut()" 
                                            class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-all text-sm font-medium">
                                        Sign Out
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                `;
            }

            getMainContent() {
                switch (this.currentView) {
                    case 'dashboard': return this.getDashboard();
                    case 'subscribers': return this.getSubscribersView();
                    case 'campaigns': return this.getCampaignsView();
                    case 'create-campaign': return this.getCreateCampaignView();
                    case 'settings': return this.getSettingsView();
                    default: return this.getDashboard();
                }
            }

            getCreateCampaignView() {
                return `
                    <div class="bg-white shadow-sm rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-6">Create New Campaign</h2>
                            
                            <!-- Step Indicator -->
                            <div class="step-indicator">
                                <div class="step ${this.campaignStep >= 1 ? (this.campaignStep === 1 ? 'active' : 'completed') : 'inactive'}">
                                    <div class="step-number">1</div>
                                    <span>Campaign Details</span>
                                </div>
                                <div class="step-separator"></div>
                                <div class="step ${this.campaignStep >= 2 ? (this.campaignStep === 2 ? 'active' : 'completed') : 'inactive'}">
                                    <div class="step-number">2</div>
                                    <span>Select Recipients</span>
                                </div>
                                <div class="step-separator"></div>
                                <div class="step ${this.campaignStep >= 3 ? 'active' : 'inactive'}">
                                    <div class="step-number">3</div>
                                    <span>Review & Send</span>
                                </div>
                            </div>

                            ${this.campaignStep === 1 ? this.getCampaignDetailsStep() : ''}
                            ${this.campaignStep === 2 ? this.getCampaignRecipientsStep() : ''}
                            ${this.campaignStep === 3 ? this.getCampaignReviewStep() : ''}
                        </div>
                    </div>
                `;
            }

            getCampaignDetailsStep() {
                return `
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Campaign Title</label>
                            <input type="text" id="campaignTitle" value="${this.newCampaign.title}" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="e.g., Weekly Newsletter #1">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Subject</label>
                            <input type="text" id="emailSubject" value="${this.newCampaign.subject}" 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                   placeholder="Subject line your subscribers will see">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Content</label>
                            <textarea id="emailContent" rows="12" 
                                      class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                      placeholder="Write your email content here...">${this.newCampaign.content}</textarea>
                        </div>

                        <div class="bg-green-50 border border-green-200 rounded-md p-4">
                            <div class="flex">
                                <i data-lucide="info" class="h-5 w-5 text-green-400 mr-2 flex-shrink-0"></i>
                                <div>
                                    <h3 class="text-sm font-medium text-green-800">Email Features:</h3>
                                    <div class="mt-1 text-sm text-green-700">
                                        <p>• Professional HTML styling automatically applied</p>
                                        <p>• Unsubscribe link automatically included</p>
                                        <p>• Mobile-responsive design</p>
                                        <p>• Will be sent from: <strong>${this.fromEmail}</strong></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button onclick="window.app.nextCampaignStep()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-all font-medium">
                                Next: Select Recipients
                            </button>
                            <button onclick="window.app.showView('campaigns')" 
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-all font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                `;
            }

            getCampaignRecipientsStep() {
                return `
                    <div class="space-y-6">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-900">Select Recipients</h3>
                            <div class="flex space-x-2">
                                <button onclick="window.app.selectAllSubscribers()" 
                                        class="text-sm bg-violet-600 text-white px-3 py-1 rounded hover:bg-blue-700 transition-all">
                                    Select All
                                </button>
                                <button onclick="window.app.deselectAllSubscribers()" 
                                        class="text-sm bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700 transition-all">
                                    Deselect All
                                </button>
                            </div>
                        </div>

                        ${this.subscribers.length === 0 ? `
                            <div class="text-center py-8">
                                <p class="text-gray-500 mb-4">No subscribers yet. Add some subscribers first.</p>
                                <button onclick="window.app.showView('subscribers')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-all">
                                    Manage Subscribers
                                </button>
                            </div>
                        ` : `
                            <div class="bg-gray-50 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    Selected: ${this.newCampaign.selectedSubscribers.length} of ${this.subscribers.length} subscribers
                                </p>
                                <div class="space-y-2 max-h-64 overflow-y-auto">
                                    ${this.subscribers.map(subscriber => `
                                        <label class="flex items-center p-2 bg-white rounded border cursor-pointer hover:bg-gray-50">
                                            <input type="checkbox" 
                                                   ${this.newCampaign.selectedSubscribers.includes(subscriber.id) ? 'checked' : ''}
                                                   onchange="window.app.toggleSubscriber(${subscriber.id})"
                                                   class="mr-3 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                            <div class="flex-1">
                                                <div class="font-medium text-sm">${subscriber.email}</div>
                                                <div class="text-xs text-gray-500">${subscriber.name || 'No name'}</div>
                                            </div>
                                            <span class="text-xs text-gray-400">${new Date(subscriber.dateAdded).toLocaleDateString()}</span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `}

                        <div class="flex space-x-4">
                            <button onclick="window.app.prevCampaignStep()" 
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-all font-medium">
                                Previous
                            </button>
                            <button onclick="window.app.nextCampaignStep()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-all font-medium"
                                    ${this.newCampaign.selectedSubscribers.length === 0 ? 'disabled' : ''}>
                                Next: Review & Send
                            </button>
                        </div>
                    </div>
                `;
            }

            getCampaignReviewStep() {
                const selectedSubs = this.subscribers.filter(s => 
                    this.newCampaign.selectedSubscribers.includes(s.id)
                );

                return `
                    <div class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-900">Review Your Campaign</h3>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3">Campaign Details</h4>
                                <div class="space-y-2 text-sm">
                                    <div><strong>Title:</strong> ${this.newCampaign.title}</div>
                                    <div><strong>Subject:</strong> ${this.newCampaign.subject}</div>
                                    <div><strong>From:</strong> ${this.fromEmail}</div>
                                    <div><strong>Recipients:</strong> ${selectedSubs.length} subscribers</div>
                                </div>
                            </div>

                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-medium text-gray-900 mb-3">Selected Recipients</h4>
                                <div class="max-h-32 overflow-y-auto text-sm space-y-1">
                                    ${selectedSubs.map(sub => `
                                        <div class="flex justify-between">
                                            <span>${sub.email}</span>
                                            <span class="text-gray-500">${sub.name || ''}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-medium text-gray-900 mb-3">Email Preview</h4>
                            <div class="bg-white border rounded p-4 max-h-48 overflow-y-auto text-sm">
                                <div class="font-bold mb-2">Subject: ${this.newCampaign.subject}</div>
                                <div class="border-t pt-2">
                                    ${this.newCampaign.content.replace(/\n/g, '<br>')}
                                </div>
                            </div>
                        </div>

                        <div class="flex space-x-4">
                            <button onclick="window.app.prevCampaignStep()" 
                                    class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-all font-medium">
                                Previous
                            </button>
                            <button onclick="window.app.sendTestEmail()" 
                                    class="bg-yellow-600 text-white px-6 py-2 rounded-md hover:bg-yellow-700 transition-all font-medium">
                                Send Test Email
                            </button>
                            <button onclick="window.app.createAndSendCampaign()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700 transition-all font-medium">
                                Send Campaign Now
                            </button>
                        </div>

                        <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                            <div class="flex">
                                <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-400 mr-2 flex-shrink-0"></i>
                                <div class="text-sm text-yellow-700">
                                    <p><strong>Before sending:</strong></p>
                                    <p>• Send a test email to yourself first</p>
                                    <p>• Make sure your @lumail.co.uk domain is set up in Resend</p>
                                    <p>• Once sent, campaigns cannot be edited or recalled</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getDashboard() {
                const totalSubscribers = this.subscribers.length;
                const activeSubscribers = this.subscribers.filter(s => s.status === 'active').length;
                const totalCampaigns = this.campaigns.length;
                const sentCampaigns = this.campaigns.filter(c => c.status === 'sent').length;

                return `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
                        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
                            <div class="p-4 sm:p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="users" class="h-5 w-5 sm:h-6 sm:w-6 text-gray-400"></i>
                                    </div>
                                    <div class="ml-3 sm:ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Subscribers</dt>
                                            <dd class="text-lg sm:text-xl font-medium text-gray-900">${totalSubscribers}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
                            <div class="p-4 sm:p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="user-check" class="h-5 w-5 sm:h-6 sm:w-6 text-green-400"></i>
                                    </div>
                                    <div class="ml-3 sm:ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">Active Subscribers</dt>
                                            <dd class="text-lg sm:text-xl font-medium text-gray-900">${activeSubscribers}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
                            <div class="p-4 sm:p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="mail" class="h-5 w-5 sm:h-6 sm:w-6 text-blue-400"></i>
                                    </div>
                                    <div class="ml-3 sm:ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">Total Campaigns</dt>
                                            <dd class="text-lg sm:text-xl font-medium text-gray-900">${totalCampaigns}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white overflow-hidden shadow-sm rounded-lg">
                            <div class="p-4 sm:p-5">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0">
                                        <i data-lucide="send" class="h-5 w-5 sm:h-6 sm:w-6 text-purple-400"></i>
                                    </div>
                                    <div class="ml-3 sm:ml-5 w-0 flex-1">
                                        <dl>
                                            <dt class="text-xs sm:text-sm font-medium text-gray-500 truncate">Sent Campaigns</dt>
                                            <dd class="text-lg sm:text-xl font-medium text-gray-900">${sentCampaigns}</dd>
                                        </dl>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-8">
                        <div class="bg-white shadow-sm rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Quick Actions</h3>
                                <div class="space-y-3">
                                    <button onclick="window.app.showView('create-campaign')" 
                                            class="w-full bg-blue-600 text-white px-4 py-3 rounded-md hover:bg-blue-700 transition-all font-medium">
                                        Create New Campaign
                                    </button>
                                    <button onclick="window.app.showView('subscribers')" 
                                            class="w-full bg-green-600 text-white px-4 py-3 rounded-md hover:bg-green-700 transition-all font-medium">
                                        Manage Subscribers
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white shadow-sm rounded-lg">
                            <div class="px-4 py-5 sm:p-6">
                                <h3 class="text-lg leading-6 font-medium text-gray-900 mb-4">Recent Campaigns</h3>
                                <div class="space-y-3">
                                    ${this.campaigns.slice(-3).reverse().map(campaign => `
                                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                            <div class="min-w-0 flex-1">
                                                <p class="font-medium text-sm truncate">${campaign.title}</p>
                                                <p class="text-xs text-gray-500">${this.getStatusBadge(campaign.status)}</p>
                                            </div>
                                            <span class="text-xs text-gray-400 ml-2">${new Date(campaign.dateCreated).toLocaleDateString()}</span>
                                        </div>
                                    `).join('') || '<p class="text-gray-500 text-sm">No campaigns yet</p>'}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getSubscribersView() {
                return `
                    <div class="bg-white shadow-sm rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Subscribers (${this.subscribers.length})</h2>
                                <button onclick="window.app.showAddSubscriberForm()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-all text-sm font-medium">
                                    Add Subscriber
                                </button>
                            </div>

                            <div id="addSubscriberForm" class="hidden mb-6 p-4 bg-gray-50 rounded-lg">
                                <h3 class="text-lg font-medium mb-3">Add New Subscriber</h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input type="email" id="newEmail" placeholder="Email address" 
                                           class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <input type="text" id="newName" placeholder="Name (optional)"
                                           class="border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div class="mt-4 flex space-x-3">
                                    <button onclick="window.app.handleAddSubscriber()" 
                                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-all">
                                        Add Subscriber
                                    </button>
                                    <button onclick="window.app.hideAddSubscriberForm()" 
                                            class="bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 transition-all">
                                        Cancel
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4">
                                ${this.subscribers.map(subscriber => `
                                    <div class="bg-gray-50 rounded-lg p-4">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="min-w-0 flex-1">
                                                <p class="font-medium text-sm text-gray-900">${subscriber.email}</p>
                                                <p class="text-xs text-gray-500">${subscriber.name || 'No name'}</p>
                                            </div>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                Active
                                            </span>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-xs text-gray-500">${new Date(subscriber.dateAdded).toLocaleDateString()}</span>
                                            <button onclick="window.app.removeSubscriber(${subscriber.id})" 
                                                    class="text-red-600 hover:text-red-900 text-sm font-medium transition-colors">
                                                Remove
                                            </button>
                                        </div>
                                    </div>
                                `).join('') || '<p class="text-gray-500 text-center py-8">No subscribers yet. Add your first subscriber!</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            getCampaignsView() {
                return `
                    <div class="bg-white shadow-sm rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900">Campaigns (${this.campaigns.length})</h2>
                                <button onclick="window.app.showView('create-campaign')" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-all text-sm font-medium">
                                    Create Campaign
                                </button>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                                ${this.campaigns.map(campaign => `
                                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                        <div class="flex justify-between items-start mb-4">
                                            <h3 class="text-base font-semibold text-gray-900 pr-2">${campaign.title}</h3>
                                            ${this.getStatusBadge(campaign.status)}
                                        </div>
                                        
                                        <p class="text-sm text-gray-600 mb-2"><strong>Subject:</strong> ${campaign.subject}</p>
                                        <p class="text-sm text-gray-500 mb-4">Created: ${new Date(campaign.dateCreated).toLocaleDateString()}</p>
                                        
                                        ${campaign.status === 'sent' ? `
                                            <div class="text-sm text-gray-600 mb-4">
                                                <p>Sent to: ${campaign.sentCount} subscribers</p>
                                                <p>Sent on: ${new Date(campaign.dateSent).toLocaleDateString()}</p>
                                            </div>
                                        ` : ''}

                                        <button onclick="window.app.deleteCampaign(${campaign.id})" 
                                                class="w-full bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700 transition-all">
                                            Delete
                                        </button>
                                    </div>
                                `).join('') || '<p class="text-gray-500 text-center py-8">No campaigns yet. Create your first campaign!</p>'}
                            </div>
                        </div>
                    </div>
                `;
            }

            getSettingsView() {
                return `
                    <div class="bg-white shadow-sm rounded-lg">
                        <div class="px-4 py-5 sm:p-6">
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-6">Settings</h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">From Email Address</label>
                                    <input type="email" id="fromEmail" value="${this.fromEmail}" 
                                           class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                           placeholder="newsletter@lumail.co.uk">
                                    <p class="mt-2 text-sm text-gray-500">
                                        Must use @lumail.co.uk domain for proper delivery.
                                    </p>
                                </div>

                                <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                                    <div class="flex">
                                        <i data-lucide="alert-triangle" class="h-5 w-5 text-yellow-400 mr-2 flex-shrink-0"></i>
                                        <div>
                                            <h3 class="text-sm font-medium text-yellow-800">Setup Required:</h3>
                                            <div class="mt-1 text-sm text-yellow-700">
                                                <p>• Add Resend API key to Vercel environment variables</p>
                                                <p>• Verify @lumail.co.uk domain in Resend dashboard</p>
                                                <p>• Set up SPF and DKIM records for deliverability</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button onclick="window.app.handleSettingsUpdate()" 
                                        class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-all font-medium">
                                    Save Settings
                                </button>
                            </div>

                            <div class="mt-8 pt-8 border-t border-gray-200">
                                <h3 class="text-lg font-medium text-gray-900 mb-4">Account Information</h3>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <p><strong>Email:</strong> ${this.user?.emailAddresses[0]?.emailAddress}</p>
                                    <p><strong>Name:</strong> ${this.user?.firstName || 'Not set'}</p>
                                    <p><strong>Subscribers:</strong> ${this.subscribers.length}</p>
                                    <p><strong>Campaigns:</strong> ${this.campaigns.length}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            getStatusBadge(status) {
                const statusConfig = {
                    'draft': { color: 'bg-yellow-100 text-yellow-800', text: 'Draft' },
                    'sending': { color: 'bg-blue-100 text-blue-800', text: 'Sending...' },
                    'sent': { color: 'bg-green-100 text-green-800', text: 'Sent' },
                    'failed': { color: 'bg-red-100 text-red-800', text: 'Failed' }
                };
                
                const config = statusConfig[status] || statusConfig['draft'];
                return `<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${config.color}">${config.text}</span>`;
            }

            // Event handlers
            initializeIcons() {
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 100);
            }

            showAddSubscriberForm() {
                const form = document.getElementById('addSubscriberForm');
                if (form) {
                    form.classList.remove('hidden');
                    document.getElementById('newEmail')?.focus();
                }
            }

            hideAddSubscriberForm() {
                const form = document.getElementById('addSubscriberForm');
                if (form) {
                    form.classList.add('hidden');
                    const emailInput = document.getElementById('newEmail');
                    const nameInput = document.getElementById('newName');
                    if (emailInput) emailInput.value = '';
                    if (nameInput) nameInput.value = '';
                }
            }

            handleAddSubscriber() {
                const email = document.getElementById('newEmail')?.value.trim();
                const name = document.getElementById('newName')?.value.trim();
                
                if (!email) {
                    alert('Please enter an email address');
                    return;
                }
                
                if (this.addSubscriber(email, name)) {
                    this.hideAddSubscriberForm();
                    this.render();
                    alert('Subscriber added successfully!');
                }
            }

            handleSettingsUpdate() {
                const fromEmail = document.getElementById('fromEmail')?.value.trim();
                
                if (!fromEmail) {
                    alert('Please enter a from email address');
                    return;
                }
                
                this.updateSettings(fromEmail);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting app...');
            window.app = new EmailCampaignApp();
        });

        // Fallback initialization
        if (document.readyState === 'loading') {
            console.log('DOM still loading, waiting...');
        } else {
            console.log('DOM already loaded, starting app immediately...');
            window.app = new EmailCampaignApp();
        }
    </script>
</body>
</html>
